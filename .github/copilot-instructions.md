# Daikin Controller Library

Daikin Controller is a TypeScript Node.js library for controlling Daikin Air Conditioner devices via their WiFi adapters. The library provides device discovery, control functions, and sensor data reading capabilities.

**Always reference these instructions first and fallback to search or bash commands only when you encounter unexpected information that does not match the info here.**

## Working Effectively

### Initial Setup
- Install dependencies: `npm ci` -- takes ~20 seconds, includes automatic build via prepare script
- Manual build: `npm run build` -- takes ~3 seconds, compiles TypeScript to lib/ directory
- Run all validation: `npm test` -- takes ~15 seconds. NEVER CANCEL. Set timeout to 30+ minutes for safety.

### Development Commands
- **Format code**: `npm run prettier` -- takes <1 second, auto-formats all TypeScript files
- **Lint with auto-fix**: `npm run lint-fix-all` -- takes ~3 seconds, may show TypeScript version warnings (safe to ignore)
- **Local device testing**: `npm run quickTestLocalNetwork` -- runs network discovery, gracefully handles no devices found
- **Manual build only**: `npm run build` -- compiles TypeScript sources from src/ to lib/

### Security and Dependencies
- Run `npm audit fix` to resolve security vulnerabilities - this is safe and recommended
- Dependencies install cleanly with occasional deprecation warnings (safe to ignore)

## Validation

### Required Validation Steps
Always run these validation steps after making changes:
1. **Build validation**: `npm run build` - verify TypeScript compilation succeeds
2. **Test validation**: `npm test` - verify all 26 tests pass with >80% coverage
3. **Format validation**: `npm run prettier` - ensure consistent code formatting
4. **Library functionality**: Test that the built library exports work correctly:
   ```bash
   node -e "const lib = require('./lib'); console.log('DaikinAC available:', typeof lib.DaikinAC);"
   ```

### Manual Validation Scenarios
After making changes to the core library:
- **Basic import test**: Verify main exports (DaikinAC, Power, Mode, FanRate enums) are accessible
- **Discovery functionality**: Run `npm run quickTestLocalNetwork` to test network device discovery
- **Type exports**: Ensure TypeScript definitions are properly generated in lib/ directory

### CI Requirements
- Always run `npm run prettier` before committing - CI will fail without proper formatting
- Linting issues in existing code are acceptable, focus only on new/changed code
- Tests must pass on Node.js 16.x, 18.x, 20.x, 22.x across Ubuntu, Windows, macOS

## Build and Test Timing Expectations
- **NEVER CANCEL** any build or test commands. All complete quickly:
  - `npm ci`: ~20 seconds
  - `npm run build`: ~3 seconds  
  - `npm test`: ~15 seconds
  - `npm run prettier`: <1 second
  - `npm run lint-fix-all`: ~3 seconds

## Project Structure

### Key Directories
- `src/` - TypeScript source code (main development area)
- `lib/` - Compiled JavaScript output (generated by build, excluded from git)
- `test/` - Jest test suites with >80% coverage
- `QuickLocalTest/` - Local network testing utility
- `.github/workflows/` - CI/CD pipeline configuration

### Core Source Files
- `src/DaikinAC.ts` - Main device controller class
- `src/DaikinACRequest.ts` - HTTP communication handling
- `src/DaikinACTypes.ts` - Type definitions and enums
- `src/DaikinDiscovery.ts` - Network device discovery
- `src/DaikinManager.ts` - Multi-device management
- `src/models/` - Data model definitions

### Configuration Files
- `package.json` - Build scripts: build, test, prettier, lint-fix-all
- `tsconfig.json` - TypeScript compilation to ES2018/CommonJS
- `jest.config.js` - Jest test configuration with ts-jest preset
- `.eslintrc.js` - ESLint with TypeScript and Prettier integration
- `.prettierrc.js` - Code formatting: 4 spaces, 120 chars, single quotes

## Common Tasks

### Adding New Features
1. Implement in `src/` with TypeScript
2. Add corresponding tests in `test/`
3. Run `npm run build && npm test && npm run prettier`
4. Verify manual validation scenarios work

### Fixing Issues
1. Identify affected source files in `src/`
2. Make minimal changes following existing patterns
3. Update relevant tests if needed
4. Validate with build/test/format commands

### Working with Device Communication
- All device communication uses HTTP GET/POST to endpoints like `/common/basic_info`
- Mock servers in tests provide realistic response data
- Discovery uses UDP broadcasts (safe to test - handles no devices gracefully)

## Library Usage Validation
After making changes, verify the library works correctly:

```bash
# Test basic exports are available
node -e "
const lib = require('./lib');
console.log('✓ DaikinAC:', typeof lib.DaikinAC);
console.log('✓ Power enum:', lib.Power);
console.log('✓ Mode enum:', lib.Mode);
"
```

## Dependencies and Environment
- **Node.js**: Supports 16.x, 18.x, 20.x, 22.x
- **TypeScript**: ~5.9.2 (may show version warnings in linting - safe to ignore)
- **Testing**: Jest with ts-jest for TypeScript support
- **HTTP Client**: node-rest-client for device communication
- **Network Discovery**: Built-in UDP socket handling

## Troubleshooting
- **Build fails**: Check TypeScript syntax in src/ files
- **Tests fail**: Review test mocks and ensure device response format changes are reflected
- **Linting errors**: Focus on new code, existing @typescript-eslint/no-explicit-any warnings are acceptable
- **Import issues**: Verify lib/ directory exists and contains compiled .js and .d.ts files